# MongoDB迁移计划和回滚方案

## 概述

本文档详细描述了将Todos应用从MySQL数据库迁移到MongoDB的完整计划，包括迁移步骤、风险评估、回滚方案和验证流程。

## 迁移目标

- **主要目标**: 将整个应用的数据存储从MySQL迁移到MongoDB
- **业务目标**: 提高数据查询性能，支持更灵活的数据结构
- **技术目标**: 简化数据访问层，减少复杂的JOIN查询

## 迁移范围

### 数据表迁移映射

| MySQL表 | MongoDB集合 | 说明 |
|---------|-------------|------|
| `groups` | `groups` | 用户组信息 |
| `users` | `users` | 用户信息 |
| `user_group_memberships` | `user_group_memberships` | 用户组成员关系 |
| `TodosList` | `todos` | 任务信息 |
| `schema_migrations` | `schema_migrations` | 迁移版本记录 |

### 代码变更范围

- **数据访问层**: 完全重写，使用Mongoose ODM
- **API层**: 更新所有数据库查询调用
- **配置文件**: 更新数据库连接配置
- **依赖管理**: 添加MongoDB相关依赖

## 迁移前准备

### 1. 环境准备

```bash
# 安装MongoDB
# Windows: 下载MongoDB Community Server
# macOS: brew install mongodb-community
# Linux: 参考官方文档安装

# 启动MongoDB服务
mongod --dbpath /path/to/data/directory

# 安装新的Node.js依赖
npm install mongoose
```

### 2. 数据备份

```bash
# 备份MySQL数据
mysqldump -h localhost -u root -p todos_db > backup_mysql_$(date +%Y%m%d_%H%M%S).sql

# 验证备份文件
ls -la backup_mysql_*.sql
```

### 3. 配置文件准备

```bash
# 复制环境配置模板
cp .env.mongodb .env

# 编辑配置文件
vim .env
```

## 迁移步骤

### 阶段1: 代码部署（无数据迁移）

**时间窗口**: 2小时
**影响**: 服务暂停

1. **停止应用服务**
   ```bash
   # 停止当前服务
   pm2 stop todos-backend
   ```

2. **部署新代码**
   ```bash
   # 拉取最新代码
   git pull origin mongodb-migration
   
   # 安装依赖
   npm install
   
   # 更新环境配置
   cp .env.mongodb .env
   vim .env  # 根据实际情况修改配置
   ```

3. **验证MongoDB连接**
   ```bash
   # 测试MongoDB连接
   node -e "require('./backend/database/mongodb-connection').testConnection().then(r => console.log('连接测试:', r))"
   ```

### 阶段2: 数据迁移

**时间窗口**: 1-4小时（取决于数据量）
**影响**: 服务暂停

1. **执行数据迁移**
   ```bash
   # 进入后端目录
   cd backend
   
   # 执行数据迁移（包含清理选项）
   node database/migration-script.js migrate --cleanup
   ```

2. **验证迁移结果**
   ```bash
   # 验证数据完整性
   node database/migration-script.js validate
   ```

3. **创建MongoDB索引**
   ```bash
   # 索引会在应用启动时自动创建
   # 也可以手动执行
   node -e "require('./database/mongodb-schema').createIndexes()"
   ```

### 阶段3: 应用启动和验证

**时间窗口**: 30分钟
**影响**: 逐步恢复服务

1. **启动应用**
   ```bash
   # 启动应用
   npm start
   
   # 或使用PM2
   pm2 start index.js --name todos-backend
   ```

2. **功能验证**
   - 用户登录/注册
   - 用户组管理
   - 任务创建/编辑/删除
   - 权限验证

3. **性能监控**
   - 响应时间监控
   - 数据库连接监控
   - 错误日志监控

## 风险评估

### 高风险项

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 数据迁移失败 | 中 | 高 | 完整备份，分步验证 |
| 数据丢失 | 低 | 高 | 多重备份，迁移前验证 |
| 性能下降 | 中 | 中 | 性能测试，索引优化 |
| 应用无法启动 | 低 | 高 | 代码审查，测试环境验证 |

### 中风险项

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 数据格式不兼容 | 中 | 中 | 数据格式转换脚本 |
| 查询性能问题 | 中 | 中 | 查询优化，索引调整 |
| 并发问题 | 低 | 中 | 事务处理，并发测试 |

## 回滚方案

### 快速回滚（30分钟内）

**触发条件**: 应用无法启动或严重功能异常

1. **停止新应用**
   ```bash
   pm2 stop todos-backend
   ```

2. **恢复旧代码**
   ```bash
   git checkout main  # 或之前的稳定版本
   npm install
   ```

3. **恢复MySQL配置**
   ```bash
   cp .env.mysql .env  # 恢复MySQL配置
   ```

4. **启动旧应用**
   ```bash
   npm start
   ```

### 完整回滚（2-4小时）

**触发条件**: 数据完整性问题或性能严重下降

1. **执行快速回滚步骤**

2. **恢复MySQL数据**（如果有数据更新）
   ```bash
   # 如果迁移期间有新数据，需要从MongoDB导出
   # 这需要自定义脚本，根据具体情况处理
   ```

3. **验证数据完整性**
   ```bash
   # 验证关键数据
   mysql -u root -p todos_db -e "SELECT COUNT(*) FROM users;"
   mysql -u root -p todos_db -e "SELECT COUNT(*) FROM TodosList;"
   ```

## 验证清单

### 数据完整性验证

- [ ] 用户数据完整性（用户名、密码、角色）
- [ ] 用户组数据完整性（组名、描述、组长）
- [ ] 任务数据完整性（任务名、描述、状态、优先级）
- [ ] 关系数据完整性（用户组成员关系）
- [ ] 时间戳数据正确性

### 功能验证

- [ ] 用户注册功能
- [ ] 用户登录功能
- [ ] 用户组管理功能
- [ ] 任务CRUD操作
- [ ] 权限控制功能
- [ ] API响应格式正确性

### 性能验证

- [ ] 登录响应时间 < 500ms
- [ ] 任务列表加载时间 < 1s
- [ ] 用户组查询时间 < 300ms
- [ ] 并发用户支持 > 100

## 监控和告警

### 关键指标监控

1. **数据库连接状态**
   - MongoDB连接池状态
   - 连接超时监控

2. **应用性能指标**
   - API响应时间
   - 错误率
   - 吞吐量

3. **业务指标**
   - 用户登录成功率
   - 任务操作成功率

### 告警设置

- 数据库连接失败 → 立即告警
- API错误率 > 5% → 5分钟内告警
- 响应时间 > 2s → 10分钟内告警

## 迁移后优化

### 短期优化（1周内）

1. **索引优化**
   - 分析慢查询日志
   - 添加复合索引
   - 优化查询语句

2. **缓存策略**
   - 实现查询结果缓存
   - 用户会话缓存

### 长期优化（1个月内）

1. **数据模型优化**
   - 评估嵌入vs引用策略
   - 优化文档结构

2. **分片策略**
   - 评估数据增长趋势
   - 制定分片计划

## 应急联系人

| 角色 | 姓名 | 联系方式 | 职责 |
|------|------|----------|------|
| 技术负责人 | - | - | 整体技术决策 |
| 数据库管理员 | - | - | 数据库操作和恢复 |
| 运维工程师 | - | - | 服务部署和监控 |
| 产品负责人 | - | - | 业务影响评估 |

## 迁移时间表

| 时间 | 活动 | 负责人 | 检查点 |
|------|------|--------|--------|
| T-7天 | 完成代码开发和测试 | 开发团队 | 代码审查通过 |
| T-3天 | 准备生产环境 | 运维团队 | 环境就绪 |
| T-1天 | 最终验证和备份 | 全团队 | 备份完成 |
| T日 | 执行迁移 | 全团队 | 迁移完成 |
| T+1天 | 监控和优化 | 运维团队 | 系统稳定 |

## 成功标准

- 所有数据成功迁移，无数据丢失
- 应用功能正常，用户体验无明显下降
- 系统性能满足预期指标
- 无严重bug或安全问题
- 回滚方案经过验证可用

---

**注意**: 本迁移计划需要根据实际环境和数据量进行调整。执行前请确保所有相关人员都已充分了解计划内容和应急处理流程。